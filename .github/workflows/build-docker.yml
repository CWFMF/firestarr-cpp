name: build-docker

on:
  push:
    branches: [ "main", "dev", "unstable" ]
    tags: [ "*" ]
  workflow_dispatch:

jobs:
  build-docker-normal:
    uses: ./.github/workflows/build-docker-image.yml
    with:
      image: firestarr
      cache-from: "type=registry,ref=ghcr.io/cwfmf/firestarr-cpp/cache:"
      cache-to: "type=registry,mode=max,ref=ghcr.io/cwfmf/firestarr-cpp/cache:"

  build-docker-minimal:
    needs: [build-docker-normal]
    uses: ./.github/workflows/build-docker-image.yml
    with:
      image: firestarr-minimal
      cache-from: "type=registry,ref=ghcr.io/cwfmf/firestarr-cpp/cache:"

  cleanup-docker-cache:
    needs: [build-docker-minimal]
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      packages: write
    steps:
      - uses: dataaxiom/ghcr-cleanup-action@v1
        with:
          delete-tags: "*-*"
          # dry-run: true
          # FIX: leave firestarr alone for now since it has the history of things from the start
          # packages: firestarr,firestarr-cpp/firestarr
          packages: firestarr-cpp/cache
          validate: true
          delete-untagged: true
          delete-ghost-images: true
          delete-partial-images: true
          delete-orphaned-images: true
